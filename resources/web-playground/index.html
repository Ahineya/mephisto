<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<button id="init">LET IT BE SOUND</button>

<input type="range" min="55" max="4000" step="0.01" value="110" id="frequency">
<input type="range" min="0" max="3" step="1" value="0" id="wave">

<button id="trig">Trig</button>

<script>
    let started = false;

    let port = null;

    document.querySelector('#init').addEventListener('click', async () => {
        if (started) {
            return;
        }

        started = true;
        const audioContext = new AudioContext();
        await audioContext.audioWorklet.addModule('processor.js');
        const modularNode = new AudioWorkletNode(audioContext, 'mephisto-generator');

        modularNode.port.onmessage = (event) => {
            console.log(event.data);
        }

        modularNode.port.postMessage({
            command: 'init'
        })

        port = modularNode.port;

        modularNode.connect(audioContext.destination);
    })

    document.querySelector('#frequency').addEventListener('input', (event) => {
        if (!port) {
            return;
        }

        port.postMessage({
            command: 'setParameter',
            setter: {
                name: 'frequency',
                value: +event.target.value
            }
        })
    });

    document.querySelector('#wave').addEventListener('input', (event) => {
        if (!port) {
            return;
        }

        port.postMessage({
            command: 'setParameter',
            setter: {
                name: 'wave',
                value: +event.target.value
            }
        })
    });

    document.querySelector('#trig').addEventListener('mousedown', () => {
        if (!port) {
            return;
        }

        port.postMessage({
            command: 'setParameter',
            setter: {
                name: 'envelope_trigger',
                value: 1
            }
        })
    })

    document.querySelector('#trig').addEventListener('mouseup', () => {
        if (!port) {
            return;
        }

        port.postMessage({
            command: 'setParameter',
            setter: {
                name: 'envelope_trigger',
                value: 0
            }
        })
    })
</script>
</body>
</html>